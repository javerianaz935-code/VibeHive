<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VibeHive | Admin Dashboard</title>

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="admindash.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        /* Specific Styles for Admin Layout (re-included for context) */
        body {
            background-color: #f0f0f0;
        }

        .admin-wrapper {
            display: flex;
            min-height: 100vh;
        }

        .admin-sidebar {
            width: 250px;
            background-color: var(--color-primary);
            color: white;
            padding-top: 20px;
            flex-shrink: 0;
        }

        .admin-content {
            flex-grow: 1;
            padding: 30px;
        }

        .sidebar-link {
            display: block;
            padding: 15px 20px;
            color: white;
            text-decoration: none;
            border-left: 5px solid transparent;
            transition: all 0.2s;
        }

        .sidebar-link:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--color-highlight);
            text-decoration: none;
        }

        .sidebar-link.active {
            background-color: rgba(255, 255, 255, 0.2);
            border-left: 5px solid var(--color-highlight);
            font-weight: bold;
        }

        .border-left-highlight {
            border-left: 5px solid var(--color-highlight) !important;
        }

        .border-left-primary {
            border-left: 5px solid var(--color-primary) !important;
        }

        .border-left-accent {
            border-left: 5px solid var(--color-accent) !important;
        }
    </style>
</head>

<body>

    <div class="admin-wrapper">
        <div class="admin-sidebar">
            <h4 class="text-center text-highlight mb-4">VibeHive Admin</h4>
            <nav>
                <a href="#" class="sidebar-link active" onclick="loadAdminSection('dashboard', event)">
                    <i class="fas fa-tachometer-alt mr-2"></i> Dashboard
                </a>
                <a href="#" class="sidebar-link" onclick="loadAdminSection('products', event)">
                    <i class="fas fa-box mr-2"></i> Manage Products
                </a>
                <a href="#" class="sidebar-link" onclick="loadAdminSection('orders', event)">
                    <i class="fas fa-clipboard-list mr-2"></i> View Orders
                </a>
                <!-- Customer Demands -->
                <a href="#" class="sidebar-link" onclick="loadAdminSection('customer-demands', event)">
                    <i class="fas fa-users mr-2"></i> Customer Demands
                </a>
                <a href="adminlogin.html" class="sidebar-link mt-5 text-danger">
                    <i class="fas fa-sign-out-alt mr-2"></i> Logout
                </a>
            </nav>
        </div>

        <div class="admin-content">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 text-primary" id="admin-title">Welcome Back, Admin</h1>
                <span class="text-muted small">System Uptime: 99.9%</span>
            </div>

            <div class="card p-4" id="main-admin-panel">
                <h4 class="text-highlight mb-3">System Overview</h4>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <div class="card bg-white p-3 border-left-highlight">
                            <p class="mb-0 text-muted small">Total Products</p>
                            <h2 class="text-primary">32</h2>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="card bg-white p-3 border-left-primary">
                            <p class="mb-0 text-muted small">Pending Orders</p>
                            <h2 class="text-danger">3</h2>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="card bg-white p-3 border-left-accent">
                            <p class="mb-0 text-muted small">New Customer Queries</p>
                            <h2 class="text-primary">2</h2>
                        </div>
                    </div>
                </div>

                <h4 class="text-primary mt-4">Quick Actions</h4>
                <button class="btn btn-primary-vibe mr-2" onclick="loadAdminSection('products', event)"><i
                        class="fas fa-plus mr-1"></i> Add New Product</button>
                <button class="btn btn-primary-vibe" style="background-color: var(--color-primary); color: white;"
                    onclick="loadAdminSection('orders', event)"><i class="fas fa-truck mr-1"></i> Update
                    Shipments</button>
            </div>

        </div>
    </div>

    <div id="toast-notification" class="fixed-top alert d-none"
        style="top: 80px; right: 20px; width: 300px; z-index: 1000;">
        <i class="mr-2 fas"></i> <span></span>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const API_BASE_URL = "http://127.0.0.1:5000"; // Flask backend

        // ---------------- Utility Toast ----------------
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast-notification');
            const toastText = toast.querySelector('span');
            const toastIcon = toast.querySelector('i');

            toastText.textContent = message;

            if (type === 'error') {
                toast.style.borderColor = 'red';
                toastIcon.classList.remove('fa-check-circle');
                toastIcon.classList.add('fa-exclamation-triangle');
            } else {
                toast.style.borderColor = getComputedStyle(document.documentElement).getPropertyValue('--color-accent');
                toastIcon.classList.remove('fa-exclamation-triangle');
                toastIcon.classList.add('fa-check-circle');
            }

            toast.classList.remove('d-none');
            setTimeout(() => toast.classList.add('d-none'), 3000);
        }

        // ---------------- Load Dashboard Stats ----------------
        async function loadDashboardStats() {
            try {
                const res = await fetch(`${API_BASE_URL}/dashboard`);
                const data = await res.json();

                document.querySelector("#main-admin-panel").innerHTML = `
                <h4 class="text-highlight mb-3">System Overview</h4>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <div class="card bg-white p-3 border-left-highlight">
                            <p class="mb-0 text-muted small">Total Products</p>
                            <h2 class="text-primary">${data.total_products}</h2>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="card bg-white p-3 border-left-primary">
                            <p class="mb-0 text-muted small">Pending Orders</p>
                            <h2 class="text-danger">${data.pending_orders}</h2>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="card bg-white p-3 border-left-accent">
                            <p class="mb-0 text-muted small">Completed Orders</p>
                            <h2 class="text-success">${data.completed_orders}</h2>
                        </div>
                    </div>
                </div>
    
                <h4 class="text-primary mt-4">Quick Actions</h4>
                <button class="btn btn-primary-vibe mr-2" onclick="loadAdminSection('products', event)">
                    <i class="fas fa-plus mr-1"></i> Add New Product
                </button>
                <button class="btn btn-primary-vibe" style="background-color: var(--color-primary); color: white;" 
                    onclick="loadAdminSection('orders', event)">
                    <i class="fas fa-truck mr-1"></i> Update Shipments
                </button>
            `;
            } catch (err) {
                console.error(err);
                showToast("Failed to load dashboard!", "error");
            }
        }

        // ---------------- Load Products ----------------
        async function loadProducts() {
            const contentDiv = document.getElementById("main-admin-panel");
            const titleElement = document.getElementById("admin-title");
            titleElement.textContent = "Manage Products";

            try {
                const res = await fetch(`${API_BASE_URL}/products`);
                const products = await res.json();

                let rows = products.map(p => `
                <tr>
                    <td>${p.product_id}</td>
                    <td>${p.product_name}</td>
                    <td>${p.main_category} / ${p.sub_category}</td>
                    <td>${p.price}</td>
                    <td>${p.stock_quantity}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="editProduct(${p.product_id})"><i class="fas fa-edit"></i> Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteProduct(${p.product_id})"><i class="fas fa-trash"></i> Delete</button>
                    </td>

                </tr>
            `).join("");

                contentDiv.innerHTML = `
                <div class="d-flex justify-content-between mb-4">
                    <h4 class="text-highlight">Product Inventory</h4>
                    <button class="btn btn-primary-vibe" style="background-color: var(--color-primary); color: white;"
                        onclick="loadAdminSection('add-product', event)">
                        <i class="fas fa-plus mr-1"></i> Add New Product
                    </button>
                </div>
                <table class="table table-striped table-bordered">
                    <thead>
                        <tr>
                            <th>ID</th><th>Name</th><th>Category</th><th>Price</th><th>Stock</th><th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>
            `;
            } catch (err) {
                console.error(err);
                showToast("Failed to load products!", "error");
            }
        }

        // ---------------- DELETE PRODUCT ----------------
        async function deleteProduct(id) {
            if (!confirm("Are you sure you want to delete this product?")) return;

            try {
                const res = await fetch(`${API_BASE_URL}/delete_product/${id}`, { method: 'DELETE' });
                const result = await res.json();

                if (res.ok) {
                    showToast(result.message, "success");
                    loadProducts();
                } else {
                    showToast(result.message, "error");
                }
            } catch (err) {
                console.error(err);
                showToast("Error deleting product!", "error");
            }
        }

        // ---------------- EDIT PRODUCT ----------------
        async function editProduct(id) {
            try {
                const res = await fetch(`${API_BASE_URL}/products`);
                const products = await res.json();
                const product = products.find(p => p.product_id === id);

                if (!product) return showToast("Product not found!", "error");

                document.getElementById("admin-title").textContent = "Edit Product";
                document.getElementById("main-admin-panel").innerHTML = `
            <h4 class="text-highlight mb-4">Edit Product</h4>
            <form onsubmit="updateProduct(event, ${id})">
                <div class="form-row">
                    <div class="form-group col-md-6">
                        <label>Product Name</label>
                        <input type="text" name="product_name" value="${product.product_name}" class="form-control" required>
                    </div>
                    <div class="form-group col-md-6">
                        <label>Category</label>
                        <select name="main_category" class="form-control" required>
                            <option value="Clothing" ${product.main_category === 'Clothing' ? 'selected' : ''}>Clothing</option>
                            <option value="Footwear" ${product.main_category === 'Footwear' ? 'selected' : ''}>Footwear</option>
                        </select>

                        <select name="sub_category" class="form-control mt-3" required>
                            <option value="Mens" ${product.sub_category === 'Mens' ? 'selected' : ''}>Mens</option>
                            <option value="Womens" ${product.sub_category === 'Womens' ? 'selected' : ''}>Womens</option>
                            <option value="Kids" ${product.sub_category === 'Kids' ? 'selected' : ''}>Kids</option>
                        </select>

                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group col-md-4">
                        <label>Price (Rs)</label>
                        <input type="number" step="0.01" name="price" value="${product.price}" class="form-control" required>
                    </div>
                    <div class="form-group col-md-4">
                        <label>Stock Quantity</label>
                        <input type="number" name="stock_quantity" value="${product.stock_quantity}" class="form-control" required>
                    </div>
                    <div class="form-group col-md-4">
                        <label>Replace Image (optional)</label>
                        <input type="file" name="image" class="form-control-file">
                    </div>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea name="description" class="form-control" rows="3">${product.description || ''}</textarea>
                </div>
                <div class="text-right mt-4">
                    <button type="submit" class="btn btn-primary-vibe" style="background-color: var(--color-primary); color: white;">
                        <i class="fas fa-save mr-1"></i> Update Product
                    </button>
                </div>
            </form>
        `;
            } catch (err) {
                console.error(err);
                showToast("Failed to load product!", "error");
            }
        }

        // ---------------- UPDATE PRODUCT ----------------
        async function updateProduct(event, id) {
            event.preventDefault();
            const formData = new FormData(event.target);

            try {
                const res = await fetch(`${API_BASE_URL}/update_product/${id}`, {
                    method: 'PUT',
                    body: formData
                });
                const result = await res.json();

                if (res.ok) {
                    showToast(result.message, "success");
                    loadProducts();
                } else {
                    showToast(result.message, "error");
                }
            } catch (err) {
                console.error(err);
                showToast("Error updating product!", "error");
            }
        }


        // ---------------- Load Orders ----------------
        async function loadOrders() {
            const contentDiv = document.getElementById("main-admin-panel");
            const titleElement = document.getElementById("admin-title");
            titleElement.textContent = "View Customer Orders";

            try {
                const res = await fetch(`${API_BASE_URL}/orders`);
                const orders = await res.json();

                let rows = orders.map(o => `
                <tr>
                    <td>${o.order_id}</td>
                    <td>${o.customer_name}</td>
                    <td>${o.order_date}</td>
                    <td>${o.total_amount}</td>
                    <td>${o.order_status}</td>
                    <td>
    <select class="form-control form-control-sm d-inline-block" style="width: 120px;"
            id="status-${o.order_id}" ${o.order_status === 'Cancelled' ? 'disabled' : ''}>
        <option value="Pending" ${o.order_status === 'Pending' ? 'selected' : ''}>Pending</option>
        <option value="Shipped" ${o.order_status === 'Shipped' ? 'selected' : ''}>Shipped</option>
        <option value="Completed" ${o.order_status === 'Completed' ? 'selected' : ''}>Completed</option>
        <option value="Cancelled" ${o.order_status === 'Cancelled' ? 'selected' : ''}>Cancelled</option>
    </select>
    <button class="btn btn-sm btn-success ml-2" 
            onclick="updateOrderStatus(${o.order_id})"
            ${o.order_status === 'Cancelled' ? 'disabled' : ''}>
        Update
    </button>
</td>

                </tr>
            `).join("");

                contentDiv.innerHTML = `
                <h4 class="text-highlight mb-4">Pending and Recent Orders</h4>
                <table class="table table-striped table-bordered">
                    <thead>
                        <tr>
                            <th>Order ID</th><th>Customer</th><th>Date</th><th>Total</th><th>Status</th><th>Manage</th>
                        </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>
            `;
            } catch (err) {
                console.error(err);
                showToast("Failed to load orders!", "error");
            }
        }

        // ---------------- UPDATE ORDER STATUS ----------------
        async function updateOrderStatus(orderId) {
            const select = document.getElementById(`status-${orderId}`);
            const newStatus = select.value;

            if (!confirm(`Are you sure you want to set this order to "${newStatus}"?`)) return;

            try {
                const res = await fetch(`${API_BASE_URL}/orders/${orderId}/status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ order_status: newStatus })
                });
                const data = await res.json();

                if (res.ok) {
                    showToast(data.message, 'success');
                    loadOrders(); // reload the table
                } else {
                    showToast(data.message, 'error');
                }
            } catch (err) {
                console.error(err);
                showToast("Error updating order status!", "error");
            }
        }


        // ---------------- Add Product ----------------
        async function addProduct(event) {
            event.preventDefault();
            const formData = new FormData(event.target);

            try {
                const res = await fetch(`${API_BASE_URL}/add_product`, {
                    method: 'POST',
                    body: formData
                });
                const result = await res.json();

                if (res.ok) {
                    showToast(result.message, "success");
                    loadProducts();
                } else {
                    showToast(result.message, "error");
                }
            } catch (err) {
                console.error(err);
                showToast("Error adding product!", "error");
            }
        }

        // ---------------- Section Loader ----------------
        function loadAdminSection(section, event) {
            if (event) event.preventDefault();

            const links = document.querySelectorAll('.sidebar-link');
            links.forEach(link => link.classList.remove('active'));
            if (event && event.target.closest('a')) event.target.closest('a').classList.add('active');

            if (section === 'dashboard') loadDashboardStats();
            else if (section === 'products') loadProducts();
            else if (section === 'orders') loadOrders();
            // Customer Demands
            else if (section === 'customer-demands') loadCustomerDemands();
            else if (section === 'add-product') {
                document.getElementById("admin-title").textContent = "Add New Product";
                document.getElementById("main-admin-panel").innerHTML = `
        <h4 class="text-highlight mb-4">Add New Product</h4>
        <form onsubmit="addProduct(event)">
            <div class="form-row">
                <div class="form-group col-md-6">
                    <label>Product Name</label>
                    <input type="text" name="product_name" class="form-control" required>
                </div>
                <div class="form-group col-md-6">
                    <label>Main Category</label>
                    <select name="main_category" class="form-control" required>
                        <option value="">Select Main Category</option>
                        <option value="Clothing">Clothing</option>
                        <option value="Footwear">Footwear</option>
                    </select>

                    <label class="mt-3">Sub Category</label>
                    <select name="sub_category" class="form-control" required>
                        <option value="">Select Sub Category</option>
                        <option value="Mens">Mens</option>
                        <option value="Womens">Womens</option>
                        <option value="Kids">Kids</option>
                    </select>

                </div>
            </div>
            <div class="form-row">
                <div class="form-group col-md-4">
                    <label>Price (Rs)</label>
                    <input type="number" step="0.01" name="price" class="form-control" required>
                </div>
                <div class="form-group col-md-4">
                    <label>Stock Quantity</label>
                    <input type="number" name="stock_quantity" class="form-control" required>
                </div>
                <div class="form-group col-md-4">
                    <label>Image Upload</label>
                    <input type="file" name="image" class="form-control-file">
                </div>
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea name="description" class="form-control" rows="3"></textarea>
            </div>
            <div class="text-right mt-4">
                <button type="submit" class="btn btn-primary-vibe" style="background-color: var(--color-primary); color: white;">
                    <i class="fas fa-save mr-1"></i> Save Product
                </button>
            </div>
        </form>
    `;
            }

        }

        // Default Load
        window.onload = loadDashboardStats;
        // Customer Demands 547-670
        async function loadCustomerDemands() {
            const contentDiv = document.getElementById("main-admin-panel");
            document.getElementById("admin-title").textContent = "Customer Price Demand Analytics";

            try {
                const res = await fetch(`${API_BASE_URL}/customer_demands`);
                const data = await res.json();

                let cards = data.map(d => `
            <div class="card shadow-sm mb-4 p-3">
                <h5 class="text-primary font-weight-bold">${d.product_name}</h5>

                <div class="row mt-3">

                    <div class="col-md-3">
                        <div class="analytics-box">
                            <h6>Current Price</h6>
                            <p class="value">Rs ${d.current_price}</p>
                        </div>
                    </div>

                    <div class="col-md-3">
                        <div class="analytics-box">
                            <h6>Avg Demand Price</h6>
                            <p class="value text-info">Rs ${d.avg_demand_price}</p>
                        </div>
                    </div>

                    <div class="col-md-3">
                        <div class="analytics-box">
                            <h6>Demand Count</h6>
                            <p class="value text-success">${d.total_demands}</p>
                        </div>
                    </div>

                    <div class="col-md-3">
                        <div class="analytics-box">
                            <h6>Demand Popularity</h6>
                            <p class="value text-warning">${d.demand_percentage}%</p>
                        </div>
                    </div>

                </div>

                <hr>

                <div class="row text-center">
                    <div class="col-md-4">
                        <p><strong>Min Demand:</strong> Rs ${d.min_demand_price}</p>
                    </div>
                    <div class="col-md-4">
                        <p><strong>Max Demand:</strong> Rs ${d.max_demand_price}</p>
                    </div>
                    <div class="col-md-4">
                        <p><strong>Difference:</strong> 
                            <span class="price-diff ${d.price_diff_abs < 0 ? 'text-danger' : 'text-success'}">
                                ${d.price_diff_abs} PKR (${d.price_diff_percentage}%)
                            </span>
                        </p>
                    </div>
                </div>

                <button class="btn btn-sm mt-3" 
                style="background-color: var(--color-primary); color: white;" 
                onclick='showDemandDetails(${JSON.stringify(d.details)})'>
                    View Customer Demands
                </button>

            </div>
        `).join("");

                contentDiv.innerHTML = `
            <style>
                .analytics-box {
                    background: #f8f9fa;
                    border-radius: 8px;
                    padding: 12px;
                    border: 1px solid #e1e1e1;
                }
                .analytics-box h6 { margin-bottom: 6px; font-size: 14px; }
                .analytics-box .value { font-size: 18px; font-weight: bold; }
                .price-diff { font-size: 16px; font-weight: bold; }
            </style>

            <h4 class="text-highlight mb-4">Customer Price Demand Insights</h4>
            ${cards}

            <div id="details-modal" class="modal" tabindex="-1" role="dialog">
                <div class="modal-dialog" role="document">
                    <div class="modal-content p-3">
                        <h5 class="mb-3">Price Demand Details</h5>
                        <div id="demand-details-content"></div>
                        <button class="btn btn-danger mt-3" onclick="closeModal()">Close</button>
                    </div>
                </div>
            </div>
        `;

            } catch (err) {
                console.error(err);
                showToast("Failed to load customer demand analytics!", "error");
            }
        }


        function showDemandDetails(details) {
            const modal = document.getElementById("details-modal");
            const content = document.getElementById("demand-details-content");

            let rows = details.map(d => `
        <div class="border p-2 mb-2">
            <strong>Email:</strong> ${d.email}<br>
            <strong>Demand Price:</strong> Rs ${d.demand_price}
        </div>
    `).join("");

            content.innerHTML = rows;
            modal.style.display = "block";
        }

        function closeModal() {
            document.getElementById("details-modal").style.display = "none";
        }
    </script>

</body>

</html>