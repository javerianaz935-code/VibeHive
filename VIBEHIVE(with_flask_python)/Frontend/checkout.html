<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VibeHive | Secure Checkout</title>

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>

<body>

    <header class="header-vibe">
    </header>

    <main class="container py-5">
        <h1 class="text-center mb-5">Secure Checkout</h1>

        <div class="row">

            <div class="col-lg-8 mb-4">

                <div class="card p-4 mb-4">
                    <h2 class="h4 mb-4 text-primary">1. Shipping Details</h2>
                    <form id="shipping-form">
                        <div class="form-group">
                            <label for="fullName">Full Name</label>
                            <input type="text" class="form-control" id="fullName" required>
                        </div>
                        <div class="form-group">
                            <label for="address">Shipping Address</label>
                            <input type="text" class="form-control" id="address" required>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label for="city">City</label>
                                <input type="text" class="form-control" id="city" required>
                            </div>
                            <div class="form-group col-md-6">
                                <label for="postalCode">Postal Code</label>
                                <input type="text" class="form-control" id="postalCode" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="phone">Contact Phone</label>
                            <input type="tel" class="form-control" id="phone" required>
                        </div>
                    </form>
                </div>

                <div class="card p-4">
                    <h2 class="h4 mb-4 text-primary">2. Select Payment Method</h2>
                    <div class="form-group">
                        <!-- <div class="form-check">
                            <input class="form-check-input" type="radio" name="paymentMethod" id="payfast"
                                value="PayFast" checked>
                            <label class="form-check-label" for="payfast">
                                Online Payment (PayFast: Card/Easypaisa/JazzCash)
                            </label>
                        </div> -->
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="paymentMethod" id="cod" value="COD"
                                checked>
                            <label class="form-check-label" for="cod">
                                Cash on Delivery (COD)
                            </label>
                        </div>

                    </div>
                </div>

                <div class="d-flex justify-content-between mt-4">
                    <a href="product-detail.html" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left"></i> Back to Cart
                    </a>

                    <button id="clear-cart-btn" class="btn btn-outline-danger">
                        <i class="fas fa-trash-alt mr-2"></i> Clear Cart
                    </button>

                    <button id="pay-now-btn" class="btn btn-primary-vibe btn-lg" onclick="simulatePayment(event)">
                        <i class="fas fa-lock mr-2"></i> Pay Now
                    </button>
                </div>

            </div>

            <div class="col-lg-4">
                <div class="card p-4 sticky-top" style="top: 20px;">
                    <h2 class="h4 mb-4 text-primary">3. Order Summary</h2>
                    <ul class="list-unstyled mb-3">
                        <!-- <li class="d-flex justify-content-between"><span>Subtotal:</span> <span id="subtotal"
                                class="text-dark">$250.00</span></li>
                        <li class="d-flex justify-content-between"><span>Shipping:</span> <span id="shippingFee"
                                class="text-dark">$15.00</span></li>
                        <li class="d-flex justify-content-between border-top pt-2 mt-2 font-weight-bold">
                            <span>Order Total:</span>
                            <span id="orderTotal" class="h5 text-highlight">$265.00</span>
                        </li> -->
                    </ul>

                    <p class="small text-muted mt-3">By clicking 'Pay Now', you agree to the Terms & Conditions.</p>
                </div>
            </div>

        </div>
    </main>

    <div id="toast-notification" class="fixed-top alert d-none"
        style="top: 80px; right: 20px; width: 300px; z-index: 1000; color: var(--color-primary); background-color: #f0f0f0; border: 2px solid var(--color-accent);">
        <i class="mr-2 fas"></i> <span></span>
    </div>

    <div id="chatbot-modal" class="chatbot-modal d-flex">
    </div>
    <div id="chatbot-icon" class="chatbot-float-icon" onclick="toggleChatbot()">
        <i class="fas fa-comment-dots"></i>
    </div>

    <footer class="footer-vibe mt-5">
    </footer>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            // Get logged-in customer from localStorage
            const customer = JSON.parse(localStorage.getItem("loggedInCustomer"));
            if (!customer) {
                window.location.href = "login.html"; // Redirect if not logged in
                return;
            }

            // Fetch the cart summary and items
            fetchCartSummary(customer.id);
            fetchCartItems(customer.id);
        });

        function fetchCartSummary(customerId) {
            console.log("üß≠ Fetching summary for:", customerId);
            fetch(`http://127.0.0.1:5000/cart/summary?customer_id=${customerId}`)
                .then(response => {
                    if (!response.ok) throw new Error("Bad response");
                    return response.json();
                })
                .then(data => {
                    console.log("‚úÖ Summary data:", data);
                    const subtotal = parseFloat(data.total_price) || 0;
                    const shippingFee = subtotal > 0 ? 15.00 : 0.00;
                    const orderTotal = subtotal + shippingFee;

                    document.getElementById("subtotal").textContent = `Rs.${subtotal.toFixed(2)}`;
                    document.getElementById("shippingFee").textContent = `Rs.${shippingFee.toFixed(2)}`;
                    document.getElementById("orderTotal").textContent = `Rs.${orderTotal.toFixed(2)}`;
                })
                .catch(err => {
                    console.error("‚ùå Error fetching summary:", err);
                    showToast("Could not load your cart. Please try again.", "error");
                });
        }

        function fetchCartItems(customerId) {
            console.log("üõí Fetching cart items for:", customerId);
            fetch(`http://127.0.0.1:5000/cart?customer_id=${customerId}`)
                .then(response => {
                    if (!response.ok) throw new Error("Bad response");
                    return response.json();
                })
                .then(items => {
                    console.log("üßæ Cart items:", items);

                    const summaryDiv = document.querySelector(".card.p-4.sticky-top ul");
                    summaryDiv.innerHTML = "";

                    let subtotal = 0;
                    items.forEach(item => {
                        const total = parseFloat(item.total) || 0;
                        subtotal += total;

                        const li = document.createElement("li");
                        li.className = "d-flex justify-content-between";
                        li.innerHTML = `<span>${item.product_name} (x${item.quantity})</span> <span>Rs.${total.toFixed(2)}</span>`;
                        summaryDiv.appendChild(li);
                    });

                    const shippingFee = subtotal > 0 ? 15.00 : 0.00;
                    const orderTotal = subtotal + shippingFee;

                    summaryDiv.innerHTML += `
                <li class="d-flex justify-content-between border-top pt-2 mt-2">
                    <span>Subtotal:</span> <span>Rs.${subtotal.toFixed(2)}</span>
                </li>
                <li class="d-flex justify-content-between">
                    <span>Shipping:</span> <span>Rs.${shippingFee.toFixed(2)}</span>
                </li>
                <li class="d-flex justify-content-between font-weight-bold border-top pt-2 mt-2">
                    <span>Total:</span> <span class="text-highlight">Rs.${orderTotal.toFixed(2)}</span>
                </li>`;
                })
                .catch(err => {
                    console.error("‚ùå Error fetching cart items:", err);
                    showToast("Could not load your cart. Please try again.", "error");
                });
        }

    </script>



    <script>
        // --- Frontend Working Functions for Checkout ---

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast-notification');
            const toastText = toast.querySelector('span');
            const toastIcon = toast.querySelector('i');

            toastText.textContent = message;

            // Set alert type styling
            if (type === 'error') {
                toast.style.borderColor = 'red';
                toastIcon.classList.remove('fa-check-circle');
                toastIcon.classList.add('fa-exclamation-triangle');
            } else {
                toast.style.borderColor = getComputedStyle(document.documentElement).getPropertyValue('--color-accent');
                toastIcon.classList.remove('fa-exclamation-triangle');
                toastIcon.classList.add('fa-check-circle');
            }

            toast.classList.remove('d-none');
            setTimeout(() => {
                toast.classList.add('d-none');
            }, 3000);
        }

        // 1. Simulate Payment Gateway Interaction
        // --- 1. Updated Payment Simulation & Checkout ---
        async function simulatePayment(event) {
            event.preventDefault(); // Prevent default form submission

            const form = document.getElementById('shipping-form');
            const requiredFields = form.querySelectorAll('[required]');
            let allFieldsValid = true;

            // Validate required fields
            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    field.classList.add('is-invalid');
                    allFieldsValid = false;
                } else {
                    field.classList.remove('is-invalid');
                }
            });

            if (!allFieldsValid) {
                showToast("Please fill in all shipping details.", 'error');
                return;
            }

            // Get payment method
            const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
            const customer = JSON.parse(localStorage.getItem("loggedInCustomer"));
            if (!customer) {
                showToast("Please log in to continue.", "error");
                window.location.href = "login.html";
                return;
            }

            // Prepare checkout data
            const checkoutData = {
                customer_id: customer.id,
                shipping_address: document.getElementById("address").value,
                phone: document.getElementById("phone").value,
                payment_method: paymentMethod
            };

            try {
                // üîπ Send checkout request to backend
                const response = await fetch("http://127.0.0.1:5000/checkout", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(checkoutData)
                });

                const result = await response.json();

                if (!response.ok) throw new Error(result.message || "Checkout failed.");

                // ‚úÖ Success: get order ID from backend response
                const orderId = result.order_ids?.[0];
                showToast("Order placed successfully!", "success");

                // üîÅ Redirect to order confirmation page
                setTimeout(() => {
                    window.location.href = `orderconfirmation.html?order_id=${orderId}`;
                }, 1500);

            } catch (error) {
                console.error("‚ùå Checkout Error:", error);
                showToast("Could not complete your order. Please try again.", "error");
            }
        }


        document.getElementById('clear-cart-btn').addEventListener('click', async () => {
            const customer = JSON.parse(localStorage.getItem("loggedInCustomer"));
            if (!customer) {
                showToast("Please log in first.", "error");
                window.location.href = "login.html";
                return;
            }

            if (!confirm("Are you sure you want to clear your cart?")) return;

            try {
                const response = await fetch("http://127.0.0.1:5000/cart/clear", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ customer_id: customer.id })
                });

                const result = await response.json();

                if (!response.ok) throw new Error(result.error || "Could not clear cart.");

                showToast(result.message, "success");
                fetchCartSummary(customer.id);
                fetchCartItems(customer.id);

            } catch (err) {
                console.error("‚ùå Clear cart error:", err);
                showToast("Failed to clear cart. Try again.", "error");
            }
        });



        // --- Chatbot Functions (Included for consistency) ---
        function toggleChatbot() {
            const modal = document.getElementById('chatbot-modal');
            modal.style.display = modal.style.display === 'flex' ? 'none' : 'flex';
        }
        function simulateChatResponse() { /* ... function body ... */ }
        // ... (Include other Chatbot functions if needed) ...

    </script>


</body>

</html>