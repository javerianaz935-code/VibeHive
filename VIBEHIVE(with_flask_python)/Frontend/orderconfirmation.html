<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VibeHive | Order Confirmed!</title>

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="orderconfirmation.css"> 
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>

<header class="header-vibe"></header>

<main class="container py-5">
    <div class="card p-5 mx-auto" style="max-width: 800px; border: 2px solid var(--color-primary);">
        
        <div class="text-center mb-4">
            <i class="fas fa-check-circle fa-5x text-highlight mb-3"></i>
            <h1 class="text-primary mb-2">Order Confirmed!</h1>
            <h2 class="h3 mb-4">Thank you for your order.</h2>
            <p class="lead font-weight-bold">
                Order ID: <span id="order-id" class="text-highlight"></span>
            </p>
        </div>
        
        <hr class="my-4">

        <h3 class="h5 mb-3 text-primary">Your Order Details</h3>

        <div class="table-responsive">
            <table class="table table-bordered text-center">
                <thead style="background-color: var(--color-background);">
                    <tr>
                        <th>Product Name</th>
                        <th>Total</th>
                        <th>Shipping Fee</th>
                        <th>Total Amount</th>
                    </tr>
                </thead>

                <tbody id="order-details-body"></tbody>

                <tfoot>
                    <tr>
                        <td colspan="3" class="text-right font-weight-bold">Final Total:</td>
                        <td class="text-highlight font-weight-bold" id="final-total"></td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <div class="text-center mt-4">
            <a href="customer_profile.html" class="btn btn-primary-vibe btn-lg">
                <i class="fas fa-truck mr-2"></i> Track Your Order
            </a>

            <a href="product.html" class="btn btn-outline-secondary btn-lg ml-3">
                Continue Shopping
            </a>
        </div>
        
    </div>
</main>

<div id="toast-notification" class="fixed-top alert d-none" style="top: 80px; right: 20px; width: 300px; z-index: 1000;">
    <i class="mr-2 fas"></i> <span></span>
</div>

<footer class="footer-vibe mt-5"></footer>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', async () => {
    const urlParams = new URLSearchParams(window.location.search);
    const orderId = urlParams.get('order_id');

    if (!orderId) {
        showToast("Missing order ID.", "error");
        return;
    }

    try {
        const response = await fetch(`http://127.0.0.1:5000/api/order/${orderId}`);
        if (!response.ok) throw new Error("Failed to load order");
        const data = await response.json();

        // Set Order ID
        document.getElementById('order-id').textContent = `VH-${data.order_id}`;

        const tableBody = document.getElementById('order-details-body');
        tableBody.innerHTML = "";

        data.items.forEach((item, index) => {
            const row = tableBody.insertRow();
            const total = (parseFloat(item.price) * item.quantity).toFixed(2);

            row.insertCell(0).textContent = `${item.product_name} (x${item.quantity})`;
            row.insertCell(1).textContent = `Rs ${total}`;

            if (index === 0) {
                row.insertCell(2).textContent = `Rs ${data.shipping_fee.toFixed(2)}`;
                row.insertCell(3).textContent = `Rs ${data.total_amount.toFixed(2)}`;
                row.cells[3].rowSpan = data.items.length;
                row.cells[3].classList.add('align-middle');
            } else {
                row.insertCell(2);
                row.insertCell(3);
            }
        });

        document.getElementById('final-total').textContent = `Rs ${data.total_amount.toFixed(2)}`;

        sessionStorage.removeItem('vibeHiveCartCount');
        updateCartBadge();

    } catch (err) {
        console.error("âŒ Error loading order:", err);
        showToast("Could not load order details.", "error");
    }
});

function showToast(message, type = 'success') {
    const toast = document.getElementById('toast-notification');
    const toastText = toast.querySelector('span');
    const toastIcon = toast.querySelector('i');

    toastText.textContent = message;
    if (type === 'error') {
        toast.style.borderColor = 'red';
        toastIcon.className = 'fas fa-exclamation-triangle';
    } else {
        toast.style.borderColor = 'green';
        toastIcon.className = 'fas fa-check-circle';
    }
    toast.classList.remove('d-none');
    setTimeout(() => toast.classList.add('d-none'), 3000);
}
</script>

</body>
</html>
